description: ft
target:
  service: amlk8s
  #name: a100-8x-wus2
  #vc: quantus
  # name: itpwus2v100cl
  # vc: gcrprojvc1
  name: v100-8x-eus-1
  vc: quantus
  #name: itplabrr1cl1     
  #vc: resrchvc

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pip install --user -e fairseq/
  - pip install --user -e infinibatch/
  - python -m nltk.downloader punkt
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: evaluate-{model_dir}/{checkpoint_name}-beam{beam}-lenpen{lenpen}-minlen{minlen}
    sku: G1
    sku_count: 1
    command:
    - bash ./shells/evaluate_xsum.sh {model_dir} {checkpoint_name} 16 {beam} {lenpen} {minlen}
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: model_dir
      spec: discrete
      values: ["/mnt/output/xsum/model/t5/lr5e-4-bsz2048-ws10000-wd0.01-dw/checkpoint_1_125000-ft/lr1e-4-bs4096-sd1-ws1000/"]
    - name: checkpoint_name
      spec: discrete
      values: ["checkpoint1.pt", "checkpoint2.pt", "checkpoint3.pt", "checkpoint4.pt", "checkpoint5.pt", "checkpoint6.pt", "checkpoint7.pt", "checkpoint8.pt"]
    - name: beam
      spec: discrete
      values: [8]
    - name: lenpen
      spec: discrete
      values: [1.0]
    - name: minlen
      spec: discrete
      values: [10]