description: ft
target:
  service: amlk8s
  #name: a100-8x-wus2
  #vc: quantus
  #name: itpwus2v100cl
  #vc: gcrprojvc1
  name: v100-8x-eus-1
  vc: quantus
  #name: itplabrr1cl1     
  #vc: resrchvc

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pwd
  - ls ~/
  - ls ./
  - ulimit -n 40960
  - pip install --user fairseq/
  - pip install --user infinibatch/
  - python -m nltk.downloader punkt
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/../..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: ft{initialization_strategy}-{branch}-{ckpt}-bs{batch_size}-lr{lr}-ws{warmup_steps}-sd{seed}
    sku: G4
    sku_count: 1
    command:
    - export PRETRAINED_MODEL_PATH=/mnt/output/PretrainedModels/electra-encoder-decoder-v3/{branch}/{ckpt}.pt
    - export DATA_DIR=/mnt/msranlp/shumma/xsum/binary_data/en-unilm/
    - export OUTPUT_DIR=/mnt/output/xsum/model/electra-encoder-decoder-v3/{branch}/{ckpt}-ft/lr{lr}-bs{batch_size}-sd{seed}-ws{warmup_steps}/{initialization_strategy}/
    - bash ./shells/finetune_xsum_electra_encoder_decoder.sh $${PRETRAINED_MODEL_PATH} $${OUTPUT_DIR} electra_encoder_decoder_v3_base {batch_size} {lr} {warmup_steps} {seed} 12 "--initialization-strategy {initialization_strategy} --generator-decoder-layers 12"
    - bash ./shells/evaluate_xsum.sh $${OUTPUT_DIR} checkpoint_best.pt 20 {beam} {lenpen} {minlen}
    - bash ./shells/evaluate_xsum.sh $${OUTPUT_DIR} checkpoint8.pt 20 {beam} {lenpen} {minlen}
    - bash ./shells/evaluate_xsum.sh $${OUTPUT_DIR} checkpoint10.pt 20 {beam} {lenpen} {minlen}
    - bash ./shells/evaluate_xsum.sh $${OUTPUT_DIR} checkpoint12.pt 20 {beam} {lenpen} {minlen}
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: branch
      spec: discrete
      values: ["lr5e-4-bsz2048-ws10000_1000_1000-wd0.01-dw25-dws-1-iw1.0-iws-1-g12d6--share-generator-discriminator","lr5e-4-bsz2048-ws10000_1000_1000-wd0.01-dw10-dws-1-iw0.5-iws-1-g12d6--share-generator-discriminator--wo-rescale-init"]
    - name: ckpt
      spec: discrete
      values: ["checkpoint_1_125000"]
    - name: seed
      spec: discrete
      values: [1]
    - name: lr
      spec: discrete
      values: ["1e-4"]
    - name: batch_size
      spec: discrete
      values: [4096]
    - name: warmup_steps
      spec: discrete
      values: [1000]
    - name: initialization_strategy
      spec: discrete
      values: ["generator"]
    - name: beam
      spec: discrete
      values: [8]
    - name: lenpen
      spec: discrete
      values: [1.0]
    - name: minlen
      spec: discrete
      values: [10]