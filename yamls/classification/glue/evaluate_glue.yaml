description: ft
target:
  service: amlk8s
  name: a100-40gb-wus3  
  vc: quantus
  #name: itpwus2v100cl
  #vc: gcrprojvc1
  #name: v100-8x-eus-1
  #vc: quantus
  #name: itplabrr1cl1     
  #vc: resrchvc
  #name: v100-8x-scus     
  #vc: quantus

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pwd
  - ls ~/
  - ls ./
  - ulimit -n 40960
  - pip install --user fairseq/
  - pip install --user infinibatch/
  #- pip install -U git+https://github.com/pltrdy/pyrouge --user 
  #- git clone https://github.com/pltrdy/files2rouge.git && cd files2rouge && echo '/tmp/code/.files2rouge/' | python setup_rouge.py && python setup.py install --user
  #- python -m nltk.downloader all > nltk.log
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/../../..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: evaluate-glue
    sku: G1
    sku_count: 1
    command:
    - export DATA_DIR=/mnt/output/glue/data-bin/{task}-bin/
    - export SAVE_DIR=/mnt/output/glue/results/
    - export TEST=/mnt/output/glue/glue_data/{task}/processed/
    - export OUTPUT_DIR=/mnt/output/glue/model/{task}/v6/lr3e-4-bsz8192-ws10000-wd0.05-dw10_0_-1-iw1.0_0_-1-g12d4/avg450000_500000-ft/lr2.5e-5-uf1-bs16-sd1-ws4000-cn0.0-wd0.05/discriminator/
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint4.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint5.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint6.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint7.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint8.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint9.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint10.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint11.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    - python ./scripts/glue/evaluate_glue.py -ckpt-path $${OUTPUT_DIR}/checkpoint12.pt -vocab-path $${DATA_DIR}/input0/dict.txt -output $${SAVE_DIR}/{task}_dev.tsv -task {task} -test-set $${TEST}/dev -label-map $${DATA_DIR}/label/dict.txt -cuda
    - python ./scripts/glue/calculate_glue.py -output $${SAVE_DIR}/{task}_dev.tsv -tasks {task}
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: task
      spec: discrete
      values: ["CoLA"]