description: ft
target:
  service: amlk8s
  #name: a100-8x-wus2     
  #vc: quantus
  #name: itplabrr1cl1     
  #vc: resrchvc
  #name: v100-8x-scus     
  #vc: quantus
  #name: itpeusp100cl    
  #vc: resrchvc
  #name: itpeusp100cl     
  #vc: resrchvc
  name: itpwus2v100cl    
  vc: gcrprojvc1
  #name: itpeusp40cl      
  #vc: resrchvc  


environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pip install --user -e fairseq/
  - pip install --user -e infinibatch/
  - git clone --single-branch --branch adding_spm_tokenized_bleu https://github.com/ngoyal2707/sacrebleu.git && cd sacrebleu && python setup.py install --user
  #- git clone https://github.com/pltrdy/files2rouge.git && cd files2rouge && echo '/tmp/code/.files2rouge/' | python setup_rouge.py && python setup.py install --user
  #- python -m nltk.downloader all > nltk.log
  #- python -m nltk.downloader punkt
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/../..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: vatex-translate-{src}2{tgt}
    sku: G1
    #sku_count: 1
    command:
    #- export INPUT=/mnt/output/M4T/VATEX/Multilingual/BT/train.en
    #- export OUTPUT=/mnt/output/M4T/VATEX/Multilingual/BT/train.{tgt}
    #- bash ./shells/create_data/translate.sh {model_dir} {checkpoint_name} {bsz} {beam} {lenpen} {src} {tgt} $${INPUT} $${OUTPUT}
    - export INPUT=/mnt/output/M4T/VATEX/Multilingual/BT/valid.en
    - export OUTPUT=/mnt/output/M4T/VATEX/Multilingual/BT/valid.{tgt}
    - bash ./shells/create_data/translate.sh {model_dir} {checkpoint_name} {bsz} {beam} {lenpen} {src} {tgt} $${INPUT} $${OUTPUT}
    - export INPUT=/mnt/output/M4T/VATEX/Multilingual/BT/test.en
    - export OUTPUT=/mnt/output/M4T/VATEX/Multilingual/BT/test.{tgt}
    - bash ./shells/create_data/translate.sh {model_dir} {checkpoint_name} {bsz} {beam} {lenpen} {src} {tgt} $${INPUT} $${OUTPUT}
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: model_dir
      spec: discrete
      values: ["/mnt/output/flores/model/electra-encoder-decoder-v6/x2x/lr3e-4-bsz8192-ws10000-wd0.05-dw10_-1_-1-iw1.0_-1_-1-g12d4/avg450000_500000-ft/lr1e-4-uf64-bs2048-sd1-ws4000-wd0.05-512_512/both-5-1.0/"]
    - name: checkpoint_name
      spec: discrete
      values: ["avg51_70.pt"]
    - name: beam
      spec: discrete
      values: [5]
    - name: lenpen
      spec: discrete
      values: [1.0]
    - name: bsz
      spec: discrete
      values: [16]
    - name: src
      spec: discrete
      values: ['en']
    - name: tgt
      spec: discrete
      #values: ['tg', 'ny']
      values: ['af', 'am', 'ar', 'as', 'ast', 'az', 'be', 'bn', 'bs', 'bg', 'ca', 'ceb', 'cs', 'ku', 'cy', 'da', 'de', 'el', 'en', 'et', 'fa', 'fi', 'fr', 'ff', 'ga', 'gl', 'gu', 'ha', 'he', 'hi', 'hr', 'hu', 'hy', 'ig', 'id', 'is', 'it', 'jv', 'ja', 'kam', 'kn', 'ka', 'kk', 'kea', 'km', 'ky', 'ko', 'lo', 'lv', 'ln', 'lt', 'lb', 'lg', 'luo', 'ml', 'mr', 'mk', 'mt', 'mn', 'mi', 'ms', 'my', 'nl', 'no', 'ne', 'ns', 'ny', 'oc', 'om', 'or', 'pa', 'pl', 'pt', 'ps', 'ro', 'ru', 'sk', 'sl', 'sn', 'sd', 'so', 'es', 'sr', 'sv', 'sw', 'ta', 'te', 'tg', 'tl', 'th', 'tr', 'uk', 'umb', 'ur', 'uz', 'vi', 'wo', 'xh', 'yo', 'zt', 'zu']
  