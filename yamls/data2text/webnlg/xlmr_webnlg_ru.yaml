description: ft
target:
  service: amlk8s
  #name: a100-8x-wus2
  #vc: quantus
  #name: itpwus2v100cl
  #vc: gcrprojvc1
  name: v100-8x-eus-1
  vc: quantus
  #name: itplabrr1cl1     
  #vc: resrchvc
  #name: a100-scus        
  #vc: language-itp-mt

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pwd
  - ls ~/
  - ls ./
  - ulimit -n 40960
  - pip install --user fairseq/
  - pip install --user infinibatch/
  - git clone https://github.com/GEM-benchmark/GEM-metrics && cd GEM-metrics && pip install -r requirements.txt -r requirements-heavy.txt
  #- pip install -U git+https://github.com/pltrdy/pyrouge --user 
  #- git clone https://github.com/pltrdy/files2rouge.git && cd files2rouge && echo '/tmp/code/.files2rouge/' | python setup_rouge.py && python setup.py install --user
  #- python -m nltk.downloader all > nltk.log
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/../../..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: ft_xlmr-webnlg-gpus1-uf{update_freq}-bs{batch_size}-lr{lr}-ws{warmup_steps}-sd{seed}-wd{weight_decay}
    sku: G1
    sku_count: 1
    command:
    - export PRETRAINED_MODEL_PATH=/mnt/output/PretrainedModels/xlmr.base/model.pt
    - export DATA_DIR=/mnt/output/webnlg/raw_data/ru/data-bin/
    - export OUTPUT_DIR=/mnt/output/webnlg/model/ru/xlmr/lr{lr}-gpus1-uf{update_freq}-bs{batch_size}-sd{seed}-ws{warmup_steps}-wd{weight_decay}/
    - bash ./shells/data2text/webnlg/xlmr_webnlg.sh $${DATA_DIR} $${PRETRAINED_MODEL_PATH} $${OUTPUT_DIR} transformer_from_xlmr_base {update_freq} {batch_size} {lr} {warmup_steps} {seed} {max_epoch} {clip_norm} {weight_decay} "--init-encoder-only"
    - python ./scripts/average_checkpoints.py --inputs $${OUTPUT_DIR} --num-epoch-checkpoints=5 --checkpoint-upper-bound=12  --output $${OUTPUT_DIR}/avg4_8.pt
    - python ./scripts/average_checkpoints.py --inputs $${OUTPUT_DIR} --num-epoch-checkpoints=5 --checkpoint-upper-bound=12  --output $${OUTPUT_DIR}/avg8_12.pt
    - python ./scripts/average_checkpoints.py --inputs $${OUTPUT_DIR} --num-epoch-checkpoints=5 --checkpoint-upper-bound=16  --output $${OUTPUT_DIR}/avg12_16.pt
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint6.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint7.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint8.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint9.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint10.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint11.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint12.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint13.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint14.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint15.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} checkpoint16.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} avg8_12.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} ru
    - bash ./shells/data2text/webnlg/evaluate_webnlg.sh $${OUTPUT_DIR} avg12_16.pt {bsz} {beam} {lenpen} {minlen} {maxlen} {split} en
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: seed
      spec: discrete
      values: [1]
    - name: lr
      spec: discrete
      values: ["8e-5","1e-4","1.2e-4"]
    - name: update_freq
      spec: discrete
      values: [1,2]
    - name: batch_size
      spec: discrete
      values: [2048]
    - name: warmup_steps
      spec: discrete
      values: [4000]
    - name: max_epoch
      spec: discrete
      values: [16]
    - name: beam
      spec: discrete
      values: [5]
    - name: lenpen
      spec: discrete
      values: [1.0]
    - name: minlen
      spec: discrete
      values: [0]
    - name: clip_norm
      spec: discrete
      values: [0.0]
    - name: weight_decay
      spec: discrete
      values: [0.0]
    - name: split
      spec: discrete
      values: ["validation"]
    - name: bsz
      spec: discrete
      values: [32]
    - name: maxlen
      spec: discrete
      values: [512]