description: ft
target:
  service: amlk8s
  name: itpwus2v100cl    
  vc: gcrprojvc1

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pip install --user -e fairseq/
  - pip install --user -e infinibatch/
  - python -m nltk.downloader punkt
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/../../..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: average_chepoints_{model_dir}
    sku: G0
    sku_count: 1
    command:
      - python ./scripts/average_checkpoints.py --inputs {model_dir} --num-epoch-checkpoints=5 --checkpoint-upper-bound=5  --output {model_dir}/avg1_5.pt
      - python ./scripts/average_checkpoints.py --inputs {model_dir} --num-epoch-checkpoints=5 --checkpoint-upper-bound=6  --output {model_dir}/avg2_6.pt
      - python ./scripts/average_checkpoints.py --inputs {model_dir} --num-epoch-checkpoints=5 --checkpoint-upper-bound=7  --output {model_dir}/avg3_7.pt
      - python ./scripts/average_checkpoints.py --inputs {model_dir} --num-epoch-checkpoints=5 --checkpoint-upper-bound=8  --output {model_dir}/avg4_8.pt
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: model_dir
      spec: discrete
      values: ["/mnt/output/wmt10/model/x2x/electra-encoder-decoder-v6/lr3e-4-bsz8192-ws10000-wd0.05-dw10_-1_-1-iw1.0_-1_-1-g12d4/avg400000_500000-ft/lr5e-4-gpus8-uf8-bs2048-sd1-ws4000-wd0.0-256_256/both-5-1.0/"]
