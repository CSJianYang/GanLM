description: ft
target:
  service: amlk8s
  name: a100-40gb-wus3
  vc: quantus
  #name: v100-8x-eus-1
  #vc: quantus
  #name: itplabrr1cl1     
  #vc: resrchvc
  #name: itplabrr1cl1     
  #vc: resrchvc

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pip install --user -e fairseq/
  - pip install --user -e infinibatch/
  - pip install -U git+https://github.com/pltrdy/pyrouge --user 
  #- git clone https://github.com/pltrdy/files2rouge.git && cd files2rouge && echo '/tmp/code/.files2rouge/' | python setup_rouge.py && python setup.py install --user
  #- python -m nltk.downloader all > nltk.log
  #- python -m nltk.downloader punkt
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/../../..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: evaluate-wmt14-fr2en-v6-{checkpoint_name}-beam{beam}-lenpen{lenpen}-minlen{minlen}
    sku: G1
    #sku_count: 1
    command:
    - export BLEU_DIR=/mnt/output/wmt14-en-fr/BLEU/v6/
    - bash ./shells/mt/wmt14-en-fr/evaluate_wmt14_en_fr.sh {model_dir} {checkpoint_name} {bsz} {beam} {lenpen} {minlen} {maxlen} {split} fr en $${BLEU_DIR}
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: model_dir
      spec: discrete
      values: ["/mnt/output/wmt14-en-fr/model/fr2en/electra-encoder-decoder-v6/lr3e-4-bsz8192-ws10000-wd0.05-dw10_-1_-1-iw1.0_-1_-1-g12d4/avg400000_500000-ft/lr1e-4-gpus8-uf32-bs2048-sd1-ws4000-wd0.05/both-5-1.0/"]
    - name: checkpoint_name
      spec: discrete
      values: ["checkpoint_best.pt"]
    - name: beam
      spec: discrete
      values: [5]
    - name: lenpen
      spec: discrete
      values: [0.8]
    - name: minlen
      spec: discrete
      values: [0]
    - name: maxlen
      spec: discrete
      values: [1024]
    - name: split
      spec: discrete
      values: ["test"]
    - name: bsz
      spec: discrete
      values: [32]
