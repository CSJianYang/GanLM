description: ft
target:
  service: amlk8s
  name: a100-40gb-wus3  
  vc: quantus
  #name: itpwus2v100cl
  #vc: gcrprojvc1
  #name: v100-8x-eus-1
  #vc: quantus
  #name: itplabrr1cl1     
  #vc: resrchvc
  #name: a100-scus        
  #vc: language-itp-mt
  #name: v100-8x-scus     
  #vc: quantus

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - pwd
  - ls ~/
  - ls ./
  - ulimit -n 40960
  - pip install --user fairseq/
  - pip install --user infinibatch/
  #- pip install -U git+https://github.com/pltrdy/pyrouge --user 
  #- git clone https://github.com/pltrdy/files2rouge.git && cd files2rouge && echo '/tmp/code/.files2rouge/' | python setup_rouge.py && python setup.py install --user
  #- python -m nltk.downloader all > nltk.log
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK
  username: shumingdocker

code:
  local_dir: $CONFIG_DIR/../../..

storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

search:
  job_template:
    name: ft_wmt16_en2ro_{initialization_strategy}-{branch}-{ckpt}-gpus8-uf{update_freq}-bs{batch_size}-lr{lr}-ws{warmup_steps}-sd{seed}-dw{discriminator_weight}-wd{weight_decay}
    sku: G8
    #sku_count: 1
    command:
    - export PRETRAINED_MODEL_PATH=/mnt/output/PretrainedModels/multilingual/electra-encoder-decoder-v6/{branch}/{ckpt}.pt
    - export DATA_DIR=/mnt/output/wmt16-en-ro/data-bin/
    - export OUTPUT_DIR=/mnt/output/wmt16-en-ro/model/en2ro/electra-encoder-decoder-v6/{branch}/{ckpt}-ft/lr{lr}-gpus8-uf{update_freq}-bs{batch_size}-sd{seed}-ws{warmup_steps}-wd{weight_decay}/{initialization_strategy}-{discriminator_weight}-{inconsistency_weight}/
    - bash ./shells/mt/wmt16-en-ro/finetune_wmt16_en_ro_electra_nlg_discriminator.sh $${DATA_DIR} $${PRETRAINED_MODEL_PATH} $${OUTPUT_DIR} electra_encoder_decoder_v6_base {update_freq} {batch_size} {lr} {warmup_steps} {seed} {max_epoch} {clip_norm} {weight_decay} {src_maxlen} {tgt_maxlen} en ro "--initialization-strategy {initialization_strategy} --generator-decoder-layers 12 --discriminator-decoder-layers {discriminator_decoder_layers} --discriminator-weight {discriminator_weight} --inconsistency-weight {inconsistency_weight}"
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint6.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint7.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint8.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint9.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint10.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint11.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint12.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint13.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint14.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    #- bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint15.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    - bash ./shells/mt/wmt16-en-ro/evaluate_wmt16_en_ro.sh $${OUTPUT_DIR} checkpoint_best.pt 24 {beam} {lenpen} {tgt_minlen} {tgt_maxlen} {split} en ro
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: branch
      spec: discrete
      values: ["lr5e-4-bsz8192-ws10000-wd0.05-dw10_-1_-1-iw1.0_-1_-1-g12d4"]
    - name: ckpt
      spec: discrete
      values: ["checkpoint_1_210000","checkpoint_1_220000","checkpoint_1_230000","checkpoint_1_240000","checkpoint_1_250000","checkpoint_1_260000","checkpoint_1_270000","checkpoint_1_280000","checkpoint_1_290000","checkpoint_1_300000","checkpoint_1_310000","checkpoint_1_320000","checkpoint_1_330000","checkpoint_1_340000","checkpoint_1_350000","checkpoint_1_360000","checkpoint_1_370000","checkpoint_1_380000","checkpoint_1_390000","checkpoint_1_400000","checkpoint_1_410000","checkpoint_1_420000","checkpoint_1_430000","checkpoint_1_440000","checkpoint_1_450000","checkpoint_1_460000","checkpoint_1_470000","checkpoint_1_480000","checkpoint_1_490000","checkpoint_1_500000"]
      #values: ["checkpoint_1_10000","checkpoint_1_20000","checkpoint_1_30000","checkpoint_1_40000","checkpoint_1_50000","checkpoint_1_60000","checkpoint_1_70000","checkpoint_1_80000","checkpoint_1_90000","checkpoint_1_100000","checkpoint_1_110000","checkpoint_1_120000","checkpoint_1_130000","checkpoint_1_140000","checkpoint_1_150000","checkpoint_1_160000","checkpoint_1_170000","checkpoint_1_180000","checkpoint_1_190000","checkpoint_1_200000","checkpoint_1_210000","checkpoint_1_220000","checkpoint_1_230000","checkpoint_1_240000","checkpoint_1_250000","checkpoint_1_260000","checkpoint_1_270000","checkpoint_1_280000","checkpoint_1_290000","checkpoint_1_300000","checkpoint_1_310000","checkpoint_1_320000","checkpoint_1_330000","checkpoint_1_340000","checkpoint_1_350000","checkpoint_1_360000","checkpoint_1_370000","checkpoint_1_380000","checkpoint_1_390000","checkpoint_1_400000","checkpoint_1_410000","checkpoint_1_420000","checkpoint_1_430000","checkpoint_1_440000","checkpoint_1_450000","checkpoint_1_460000","checkpoint_1_470000","checkpoint_1_480000","checkpoint_1_490000","checkpoint_1_500000"]
    - name: seed
      spec: discrete
      values: [1]
    - name: lr
      spec: discrete
      values: ["1e-4"]
    - name: update_freq
      spec: discrete
      values: [2]
    - name: batch_size
      spec: discrete
      values: [2048]
    - name: warmup_steps
      spec: discrete
      values: [4000]
    - name: max_epoch
      spec: discrete
      values: [16]
    - name: initialization_strategy
      spec: discrete
      values: ["both"]
    - name: beam
      spec: discrete
      values: [8]
    - name: lenpen
      spec: discrete
      values: [0.8]
    - name: discriminator_weight
      spec: discrete
      values: [5]
    - name: inconsistency_weight
      spec: discrete
      values: [1.0]
    - name: clip_norm
      spec: discrete
      values: [0.0]
    - name: weight_decay
      spec: discrete
      values: [0.05]
    - name: split
      spec: discrete
      values: ["test"]
    - name: discriminator_decoder_layers
      spec: discrete
      values: [4]  
    - name: src_maxlen
      spec: discrete
      values: [1024]
    - name: tgt_minlen
      spec: discrete
      values: [0]
    - name: tgt_maxlen
      spec: discrete
      values: [1024]
    