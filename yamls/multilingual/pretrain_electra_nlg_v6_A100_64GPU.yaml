description: V100LargePretrainElectra
target:
  service: amlk8s
  #name: a100-scus
  #vc: language-itp-mt
  #vc: language-itp-mtprod
  #name: itp-a100-wus3    
  #vc: language-itp-mtprod
  name: a100-8x-wus2
  vc: quantus
  #name: a100-scus        
  #vc: language-itp-mt

environment:
  image: nvidia/20.09:v7.0.2
  registry: shumingdocker.azurecr.io
  setup:
  - ibstat
  - ulimit -n 40960
  - pip install --user fairseq/
  - pip install --user infinibatch/
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK
  username: shumingdocker
  
storage:
  msranlp:
    storage_account_name: msranlp
    container_name: unilm
  output:
    storage_account_name: yangjianunilm
    container_name: unilm

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  # "--share-generator-discriminator"
  local_dir: $CONFIG_DIR/../..
#--rescale-init
#--share-generator-discriminator
search:
  job_template:
    name: __pretrain_multilingual_nlg_electra_lr{lr}_ws{warmup_steps}_wd{weight_decay}_dw{discriminator_weight}_{discriminator_start_warmup_steps}_{discriminator_warmup_steps}_iw{inconsistency_weight}_{inconsistency_start_warmup_steps}_{discriminator_warmup_steps}_g{generator_decoder_layers}d{discriminator_decoder_layers}__
    sku: G8
    sku_count: 8
    aml_mpirun:
      communicator: OpenMpi
    command:
      - bash ./shells/multilingual/pretrain_electra_nlg_v6.sh /mnt/msranlp/shumma/data/deltalm/ 8 16 8 {max_update} {lr} {warmup_steps} {weight_decay} {discriminator_weight} {discriminator_warmup_steps} {inconsistency_weight} {inconsistency_warmup_steps} {generator_decoder_layers} {discriminator_decoder_layers} {discriminator_start_warmup_steps} {inconsistency_start_warmup_steps} {discriminator_sampling_temperature} {seed} {max_source_positions} {max_target_positions}
    submit_args:
      env:
        NCCL_DEBUG: INFO
        MKL_NUM_THREADS: 1
        OMP_NUM_THREADS: 1
  type: grid
  max_trials: 500
  params:
    - name: seed
      spec: discrete
      values: [1]
    - name: lr
      spec: discrete
      values: [3e-4]
    - name: warmup_steps
      spec: discrete
      values: [10000]
    - name: weight_decay
      spec: discrete
      values: [0.05]
    - name: discriminator_start_warmup_steps
      spec: discrete
      values: [-1]
    - name: inconsistency_start_warmup_steps
      spec: discrete
      values: [-1]
    - name: discriminator_weight
      spec: discrete
      values: [10]
    - name: discriminator_warmup_steps
      spec: discrete
      values: [-1]
    - name: inconsistency_weight
      spec: discrete
      values: [1.0]
    - name: inconsistency_warmup_steps
      spec: discrete
      values: [-1]
    - name: generator_decoder_layers
      spec: discrete
      values: [12]
    - name: discriminator_decoder_layers
      spec: discrete
      values: [4]
    - name: discriminator_sampling_temperature
      spec: discrete
      values: [1.0]
    - name: max_update
      spec: discrete
      values: [500000]
    - name:  max_source_positions
      spec: discrete
      values: [1024]
    - name:  max_target_positions
      spec: discrete
      values: [1024]